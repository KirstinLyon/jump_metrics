---
title: "Event Overview"
output:
  flexdashboard::flex_dashboard:
    theme: yeti
runtime: shiny
editor_options:
  markdown:
    wrap: 72
---

# Event Overview


## column {.sidebar}

This dashboard displays the results for an individual event. Use the provided filters to customise the data and update the view according to your preferences.

```{r}
# Sort competitor names alphabetically

latest_year <- max(start_data$Event_Year)

selectInput("Event_Year", "Event Year",
            choices = sort(unique(start_data$Event_Year)),
            selected = latest_year)

selectInput('Event', 'Event',
            choices = start_data$Event)  # Set default to the first name in the sorted list

selectInput('Competition', 'Competition', choices = start_data$Competition)  # Set default to the first name in the sorted list

pickerInput(
  inputId = "is_complete_2",
  label = "Skills Complete:", 
  choices = unique(start_data$is_complete),
  selected = c("Complete"),
  options = list(
    `actions-box` = TRUE  # Adds "Select All" buttons
  ),
  multiple = TRUE  # Allows multiple selections
)


pickerInput(
  inputId = "Stage_2",
  label = "Select Stage(s):", 
  choices = unique(start_data$Stage),
  selected = c("Final", "Qualification_2"),
  options = list(
    `actions-box` = TRUE,  # Adds "Select All" buttons
    `selected-text-format` = "count > 2"  # Shows count when >2 selected
  ),
  multiple = TRUE  # Allows multiple selections
)


# Observe changes in Club selection to update other inputs
# Observe changes in Club selection to update Competitor input
observeEvent(input$Event_Year, {
  if (input$Event_Year != "") {  # Only update if a club is selected
    filtered_data <- start_data |> filter(Event_Year == input$Event_Year)
    updateSelectInput(session, 'Event', choices = sort(unique(filtered_data$Event)))
  } else {
    updateSelectInput(session, 'Event', choices = NULL)
  }
})

# Observe changes in Competitor selection to update other inputs
observeEvent(input$Event, {
  if (input$Event != "") {  # Only update if a competitor is selected
    filtered_data <- start_data |>  filter(Event == input$Event)
    updateSelectInput(session, 'Competition', choices = sort(unique(filtered_data$Competition)))
    updatePickerInput(session, 'is_complete_2', 
                      choices = sort(unique(filtered_data$is_complete)), 
                      selected = "Complete")
    updatePickerInput(session, 'Stage_2', 
                      choices = sort(unique(filtered_data$Stage)), 
                      selected = c("Final", "Qualification_2"))
  } else {
    updateSelectInput(session, 'Competition', choices = NULL, selected = "Competition")
    updatePickerInput(session, 'is_complete_2', 
                      choices = unique(start_data$is_complete), 
                      selected = "Complete")
    
    updatePickerInput(session, 'Stage_2', 
                      choices = unique(start_data$Stage), 
                      selected = c("Final", "Qualification_2"))
  }
})


```

## column {data-width="300"}
```{r}

# Use a div with a specific height to create space
div(style = "height: 24px;")  # Adjust the height as needed

# Text output with dynamic content and inline styles
div(style = "font-size: 24px; font-weight: bold;", textOutput("eventLabel"))
# Server logic to update the text output
output$eventLabel <- renderText({
  selected_event <- input$Event
  if (selected_event != "") {
    paste(selected_event)
  } else {
    "No Event selected"
  }
})
```

### Execution

```{r}

plotlyOutput("e_plot")

output$e_plot <- renderPlotly({
  
  # Data filtering and processing
  df <- update_raw_data() |>
    filter(
      Event == input$Event,
      Competition == input$Competition,
      Stage %in% input$Stage_2,
      is_complete %in% input$is_complete_2
    ) 
  
  req(nrow(df) > 0)
  
  df <- df |>
    mutate(Rank = as.numeric(factor(Rank)))
  
  # Create ggplot with text for tooltips
  p <- ggplot(df, aes(x = Rank, y = Execution, color = Stage)) +
    geom_jitter(aes(text = paste(Competitor,  "<br>Rank: ", Rank, "<br>Execution: ", Execution)), width = 0.1, height = 0) +
    theme_minimal() +
    scale_x_continuous(breaks = NULL) +  # Remove x-axis ticks 
    expand_limits(y = 0)
  
  # Convert ggplot to Plotly and ensure hover tooltips are enabled
  ggplotly(p, tooltip = "text") %>%
    layout(
      hovermode = "closest",  # Ensure hover tooltips work
      dragmode = "zoom"       # Allow zooming and panning
    ) %>%
    config(
      displayModeBar = FALSE  # Remove the mode bar (zoom, lasso, etc.)
    )
})
```

### Time of Flight(Seconds)

```{r}

plotlyOutput("tof_plot")

output$tof_plot <- renderPlotly({
  
  # Data filtering and processing
  df <- update_raw_data() |>
    filter(
      Event == input$Event,
      Competition == input$Competition,
      Stage %in% input$Stage_2,
      is_complete %in% input$is_complete_2
    ) 
  
  req(nrow(df) > 0)
  
  df <- df |>
    mutate(Rank = as.numeric(factor(Rank)))
  
  # Create ggplot with text for tooltips
  p <- ggplot(df, aes(x = Rank, y = T, color = Stage)) +
    geom_jitter(aes(text = paste(Competitor,  "<br>Rank: ", Rank, "<br>ToF: ", T)), width = 0.1, height = 0) +
    theme_minimal() +
    scale_x_continuous(breaks = NULL) +  # Remove x-axis ticks 
    expand_limits(y = 0)
  
  # Convert ggplot to Plotly and ensure hover tooltips are enabled
  ggplotly(p, tooltip = "text") %>%
    layout(
      hovermode = "closest",  # Ensure hover tooltips work
      dragmode = "zoom"       # Allow zooming and panning
    ) %>%
    config(
      displayModeBar = FALSE  # Remove the mode bar (zoom, lasso, etc.)
    )
})
```


### Difficulty
```{r}

plotlyOutput("dd_plot")

output$dd_plot <- renderPlotly({
  
  # Data filtering and processing
  df <- update_raw_data() |>
    filter(
      Event == input$Event,
      Competition == input$Competition,
      Stage %in% input$Stage_2,
      is_complete %in% input$is_complete_2
    ) 
  
  req(nrow(df) > 0)
  
  df <- df |>
    mutate(Rank = as.numeric(factor(Rank)))
  
  # Create ggplot with text for tooltips
  p <- ggplot(df, aes(x = Rank, y = D, color = Stage)) +
    geom_jitter(aes(text = paste(Competitor,  "<br>Rank: ", Rank, "<br>DD: ", D)), width = 0.1, height = 0) +
    theme_minimal() +
    scale_x_continuous(breaks = NULL) +  # Remove x-axis ticks 
    expand_limits(y = 0)
  
  # Convert ggplot to Plotly and ensure hover tooltips are enabled
  ggplotly(p, tooltip = "text") %>%
    layout(
      hovermode = "closest",  # Ensure hover tooltips work
      dragmode = "zoom"       # Allow zooming and panning
    ) %>%
    config(
      displayModeBar = FALSE  # Remove the mode bar (zoom, lasso, etc.)
    )
})
```


### Horizontal Displacement



```{r}
plotlyOutput("hd_plot")

output$hd_plot <- renderPlotly({
  
  # Data filtering and processing
  df <- update_raw_data() |>
    filter(
      Event == input$Event,
      Competition == input$Competition,
      Stage %in% input$Stage_2,
      is_complete %in% input$is_complete_2
    ) 
  
  req(nrow(df) > 0)
  
  df <- df |>
    mutate(Rank = as.numeric(factor(Rank)))
  
  # Create ggplot with text for tooltips
  p <- ggplot(df, aes(x = Rank, y = H, color = Stage)) +
    geom_jitter(aes(text = paste(Competitor,  "<br>Rank: ", Rank, "<br>HD: ", H)), width = 0.1, height = 0) +
    theme_minimal() +
    scale_x_continuous(breaks = NULL) +  # Remove x-axis ticks 
    expand_limits(y = 0)
  
  # Convert ggplot to Plotly and ensure hover tooltips are enabled
  ggplotly(p, tooltip = "text") %>%
    layout(
      hovermode = "closest",  # Ensure hover tooltips work
      dragmode = "zoom"       # Allow zooming and panning
    ) %>%
    config(
      displayModeBar = FALSE  # Remove the mode bar (zoom, lasso, etc.)
    )
})

```





## Column {data-width="700"}

```{r}

# Use a div with a specific height to create space
div(style = "height: 24px;")  # Adjust the height as needed

# Text output with dynamic content and inline styles
div(style = "font-size: 24px; font-weight: bold;", textOutput("competitionLabel"))
# Server logic to update the text output
output$competitionLabel <- renderText({
  selected_competition <- paste("Competition:", input$Competition)
  if (selected_competition != "") {
    paste(selected_competition)
  } else {
    "No Competition selected"
  }
})
```

### 

```{r}
renderReactable({
  # Filter and prepare data
  plot_data <- score_data %>%
    filter(
      Event == input$Event,
      Competition == input$Competition,
      Stage %in% input$Stage_2,
      is_complete %in% input$is_complete_2 
    ) |> 
    select(-c(Event_Year, Event, Competition, Date, is_complete, Total)) |> 
    arrange(Stage, Rank)
  
  # Verify data structure
  if(!all(c("Execution","T", "D", "H") %in% names(plot_data))) {
    stop("Required columns (Execution, T, D, H) not found in data")
  }
  
  reactable(
    plot_data,
    defaultColDef = colDef(
      headerStyle = list(background = "#f7f7f7"),
      style = list(fontSize = "0.9em"),
      align = "left"
    ),
    columns = list(
      Execution = colDef(
        cell = reactablefmtr::data_bars(
          data = plot_data,
          fill_color = "#e0e0e0",
          background = "transparent",
          text_position = "inside-base",
          min_value = 0,
          max_value = 22,
          number_fmt = function(x) sprintf("%.1f", x)
        )
      ),
      T = colDef(
        cell = reactablefmtr::data_bars(
          data = plot_data,
          fill_color = "#e0e0e0",
          background = "transparent",
          text_position = "inside-base",
          min_value = 0,
          max_value = 22,
          number_fmt = function(x) sprintf("%.1f", x)
        )
      ),
      H = colDef(
        cell = reactablefmtr::data_bars(
          data = plot_data,
          fill_color = "#e0e0e0",
          background = "transparent",
          text_position = "inside-base",
          min_value = 0,
          max_value = 22,
          number_fmt = function(x) sprintf("%.1f", x)
        )
      ),
      D = colDef(
        cell = reactablefmtr::data_bars(
          data = plot_data,
          fill_color = "#e0e0e0",
          background = "transparent",
          text_position = "inside-base",
          min_value = 0,
          max_value = 22,
          number_fmt = function(x) sprintf("%.1f", x)
        )
      )
    ),
    highlight = TRUE,
    bordered = TRUE,
    pagination = TRUE,
    showPageSizeOptions = TRUE,
    pageSizeOptions = c(10, 25, 50, 100)
  )
})
```