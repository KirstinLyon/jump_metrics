---
title: "Kickout"
output:
  flexdashboard::flex_dashboard:
    navbar:
    - title: Me
      href: https://mltwelve.com/
      icon: "fa-home"
    theme: yeti
runtime: shiny
editor_options:
  markdown:
    wrap: 72
resource_files:
- "Images/trampoline-2589684135.jpg"
---

# Welcome to Kickout!

```{r setup, include=FALSE}
library(DT)
library(dplyr)
library(flexdashboard)
library(shiny)
library(readr)
library(lubridate)
library(ggplot2)
library(plotly)
library(shinyWidgets)
library(tidyr)


# Source the script that generates the 'events' dataset
events <- read_csv("Dataout/all_events.csv")


# events <-  read_csv("https://raw.githubusercontent.com/KirstinLyon/jump_metrics/refs/heads/main/Dataout/all_events.csv?token=GHSAT0AAAAAAC4QU5H3TALWBYUEP4K2ELQ22ALH6MQ")
# Use the 'events' dataset generated by fetch_data.R
start_data <- events  |> 
  mutate(Year = lubridate::year(Date)) |> 
  select(Year, Date, Event,Event_Year, Competition, Competitor, Birth_Year,Country, Club, Stage,
         Rank, Total, Mark, Elements, Execution, T, D, H, is_complete)  


compact_data <- start_data 

update_raw_data <- reactive({
  compact_data
})

detailed_data <- events |> 
  select(Date, Event,Event_Year, Competition, Competitor, Country, Club, Stage, Total, Mark, Elements, Execution, T, D, H,
         s1, s2, s3, s4, s5, s6, s7, s8, s9, s10, l, t1, t2, t3, t4, t5, t6, t7, t8, t9, t10, is_complete) 


update_detailed_data <- reactive({
  detailed_data
})


score_data <- events |> 
  select(Date, Event,Event_Year, Competition, Rank, Competitor, Country, Club, Stage, Total, Mark, Elements, Execution, T, D, H, is_complete) 

update_score_data <- reactive({
  score_data
})

```

## Column {data-width="600"}

**Kickout - Analysing Trampoline Competition Data**

This app delivers insights into individual trampoline events, with a
special focus on trampoline gymnasts in Denmark, particularly those from
KÃ¸benhavns Trampoline Club (KTK). Powered by data from SportTech.io, the
app is updated every Monday. The data coverage begins from 2023 onwards,
providing a current and relevant overview of trampoline events and
performances.

Events included in Data

\- Dancup 1, 2 and 3

\- DM (aka Forbundsmesterskb u13, u15 and u17)

\- DM Senior

\- DM Senior Hold

\- FIG Trampoline World Cup

\- Nordic Trampoline Championships

\- Scandinavian Open

## Column {data-width="200"}

## Column {data-width="600"}


<img src="Images/trampoline-2589684135.jpg" width="500"/>


[Rules from FIG](https://www.gymnastics.sport/site/rules/#7)

# Competitor Overview 

## Column {.sidebar}

This dashboard displays the results for an individual competitor. Use the provided filters to customise the data and update the view according to your preferences.

```{r}

# Sort competitor names alphabetically
sorted_club <- sort(unique(start_data$Club))


selectInput('Club', 'Club',
            choices = sorted_club,
            selected = "KTK")  # Set default to the first name in the sorted list

selectInput('Competitor', 'Competitor', choices = NULL)
selectInput('is_complete', 'Skills', choices = start_data$is_complete, selected = "Complete")
pickerInput(
  inputId = "Stage",
  label = "Select Stage(s):", 
  choices = unique(start_data$Stage),
  selected = c("Final", "Qualification_2"),
  options = list(
    `actions-box` = TRUE,  # Adds "Select All" buttons
    `selected-text-format` = "count > 2"  # Shows count when >2 selected
  ),
  multiple = TRUE  # Allows multiple selections
)


# Observe changes in Club selection to update other inputs
# Observe changes in Club selection to update Competitor input
observeEvent(input$Club, {
  if (input$Club != "") {  # Only update if a club is selected
    filtered_data <- start_data |> filter(Club == input$Club)
    updateSelectInput(session, 'Competitor', choices = sort(unique(filtered_data$Competitor)))
  } else {
    updateSelectInput(session, 'Competitor', choices = NULL)
  }
})

# Observe changes in Competitor selection to update other inputs
observeEvent(input$Competitor, {
  if (input$Competitor != "") {  # Only update if a competitor is selected
    filtered_data <- start_data |>  filter(Competitor == input$Competitor)

    updateSelectInput(session, 'Stage', choices = sort(filtered_data$Stage), selected = c("Final", "Qualification_2"))
    updateSelectInput(session, 'is_complete', choices = sort(unique(filtered_data$is_complete)))
  } else {

    updateSelectInput(session, 'Stage', choices = NULL, selected = c("Final", "Qualification_2"))
    updateSelectInput(session, 'is_complete', choices = NULL, selected = "Complete")
  }
})

```

## Column {data-width="300"}

```{r}

# Use a div with a specific height to create space
div(style = "height: 24px;")  # Adjust the height as needed

# Text output with dynamic content and inline styles
div(style = "font-size: 24px; font-weight: bold;", textOutput("competitorLabel"))
# Server logic to update the text output
output$competitorLabel <- renderText({
  selected_competitor <- input$Competitor
  if (selected_competitor != "") {
    paste(selected_competitor)
  } else {
    "No Competitor selected"
  }
})
```

### Execution

```{r}
renderPlot({
 update_raw_data() |> 
    filter(
           Stage %in% input$Stage,
           Competitor == input$Competitor,
           is_complete == input$is_complete)  |>
    ggplot(aes(x = Date, y = Execution, colour = Stage)) +
    geom_line(linewidth = 0.95) +
    geom_point(size = 3) +  # This adds dots for each data point
    scale_color_hue(direction = 1) +
    labs( y = "Execution") +
    theme_minimal() +
    theme(legend.position = "top", legend.justification = "right")+
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

### Difficulty

```{r}
renderPlot({
 update_raw_data() |> 
    filter(
           Stage %in% input$Stage,
           Competitor == input$Competitor,
           is_complete == input$is_complete)  |>
    ggplot(aes(x = Date, y = D, colour = Stage)) +
    geom_line(linewidth = 0.95) +
    geom_point(size = 3) +  # This adds dots for each data point
    scale_color_hue(direction = 1) +
    labs( y = "Difficulty") +
    theme_minimal() +
    theme(legend.position = "top", legend.justification = "right")+
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

### Time of Flight (Seconds)

```{r}
renderPlot({
 update_raw_data() |> 
    filter(
           Stage %in% input$Stage,
           Competitor == input$Competitor,
           is_complete == input$is_complete)  |>
    ggplot(aes(x = Date, y = T, colour = Stage)) +
    geom_line(linewidth = 0.95) +
    geom_point(size = 3) +  # This adds dots for each data point
    scale_color_hue(direction = 1) +
    labs(y = "Time of Flight (S)") +
    theme_minimal() +
    theme(legend.position = "top", legend.justification = "right")+
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

### Horizontal Displacement

```{r}
renderPlot({
 update_raw_data() |> 
    filter(
           Stage %in% input$Stage,
           Competitor == input$Competitor,
           is_complete == input$is_complete)  |>
    ggplot(aes(x = Date, y = H, colour = Stage)) +
    geom_line(linewidth = 0.95) +
    geom_point(size = 3) +  # This adds dots for each data point
    scale_color_hue(direction = 1) +
    labs(y = "Horizontal Displacement") +
    theme_minimal() +
    theme(legend.position = "top", legend.justification = "right")+
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

## Column {data-width="600"}

```{r}
div(style = "height: 55px;")  # Adjust the height as needed
textOutput("competitorLabel_1")

output$competitorLabel_1 <- renderText({
  paste("")  # This will render as empty text
})
```

### Overall Scores

```{r}

renderDT({
  # Filter the data using dplyr
  filtered_data <- score_data |> 

    filter(

           Competitor == input$Competitor,
           Stage %in% input$Stage,
           is_complete == input$is_complete 

)   |> 
    
    select(-c(Date, Country, is_complete, Club, Total, Competitor)) |> 
    rename(Year = Event_Year) |> 
    select(Year, Event, everything())

  # Render the data table with DT
datatable(
  filtered_data,
  rownames = FALSE,
    options = list(
    lengthMenu = list(c(25,50,100,-1),c(25,50,100,"All"))
  )
  
  
  )

})


```


# Competitor Skills & ToF

## column {.sidebar}

This dashboard displays the results skills and ToF for an individual Competitor. Use the provided filters to customise the data and update the view according to your preferences.

```{r}

# Sort competitor names alphabetically
sorted_club <- sort(unique(start_data$Club))


selectInput('Club_1', 'Club',
            choices = sorted_club,
            selected = "KTK")  # Set default to the first name in the sorted list

selectInput('Competitor_1', 'Competitor', choices = NULL)
selectInput('is_complete_1', 'Skills', choices = start_data$is_complete, selected = "Complete")
pickerInput(
  inputId = "Stage_1",
  label = "Select Stage(s):", 
  choices = unique(start_data$Stage),
  selected = c("Final", "Qualification_2"),
  options = list(
    `actions-box` = TRUE,  # Adds "Select All" buttons
    `selected-text-format` = "count > 2"  # Shows count when >2 selected
  ),
  multiple = TRUE  # Allows multiple selections
)


# Observe changes in Club selection to update other inputs
# Observe changes in Club selection to update Competitor input
observeEvent(input$Club_1, {
  if (input$Club != "") {  # Only update if a club is selected
    filtered_data <- start_data |> filter(Club == input$Club_1)
    updateSelectInput(session, 'Competitor_1', choices = sort(unique(filtered_data$Competitor)))
  } else {
    updateSelectInput(session, 'Competitor_1', choices = NULL)
  }
})

# Observe changes in Competitor selection to update other inputs
observeEvent(input$Competitor_1, {
  if (input$Competitor_1 != "") {  # Only update if a competitor is selected
    filtered_data <- start_data |>  filter(Competitor == input$Competitor_1)

    updateSelectInput(session, 'Stage_1', choices = sort(filtered_data$Stage), selected = c("Final", "Qualification_2"))
    updateSelectInput(session, 'is_complete_1', choices = sort(unique(filtered_data$is_complete)))
  } else {

    updateSelectInput(session, 'Stage_1', choices = NULL, selected = c("Final", "Qualification_2"))
    updateSelectInput(session, 'is_complete_1', choices = NULL, selected = "Complete")
  }
})

```

## column {data-width="400"}

```{r}

# Use a div with a specific height to create space
div(style = "height: 24px;")  # Adjust the height as needed

# Text output with dynamic content and inline styles
div(style = "font-size: 24px; font-weight: bold;", textOutput("competitorLabel_detail"))
# Server logic to update the text output
output$competitorLabel_detail <- renderText({
  selected_competitor <- input$Competitor_1
  if (selected_competitor != "") {
    paste(selected_competitor)
  } else {
    "No Competitor selected"
  }
})
```

### Skills & ToF (Seconds)

```{r}
renderDT({
  # Filter the data using dplyr
  filtered_data <- detailed_data |> 

    filter(

           Competitor == input$Competitor_1,
           Stage %in% input$Stage_1,
           is_complete == input$is_complete_1 

)   |> 
    select(-c(Date, Country, is_complete, Club, Total, Competitor,
              t1, t2, t3, t4, t5, t6, t7, t8, t9, t10)) |> 
    rename(Year = Event_Year) |> 
    select(Year, Event, everything())

  # Render the data table with DT
datatable(
  filtered_data,
  rownames = FALSE,
  options = list(
    columnDefs = list(list(
      targets = 10:20, # Apply to all columns except the first one
      render = JS(
        "function(data, type, row) {",
        "  var value = parseFloat(data);",
        "  var min = 1;",
        "  var max = 10;",
        "  var ratio = (value - min) / (max - min);",
        "  var r = Math.max(0, Math.min(255, Math.floor(175 + 80 * (1 - ratio))));",
        "  var g = Math.max(0, Math.min(255, Math.floor(238 + 13 * (1 - ratio))));",
        "  var b = Math.max(0, Math.min(255, Math.floor(238 + 13 * (1 - ratio))));",
        "  var color = 'rgb(' + r + ', ' + g + ', ' + b + ')';",
        "  var textColor =  'black';",
        "  return '<div style=\"background-color:' + color + '; color:' + textColor + '; text-align:center;\">' + data + '</div>';",
        "}"
      )
    ))
  )
)
})

```


# Event Overview


## column {.sidebar}

This dashboard displays the results for an individual event. Use the provided filters to customise the data and update the view according to your preferences.

```{r}
# Sort competitor names alphabetically

latest_year <- max(start_data$Event_Year)

selectInput("Event_Year", "Event Year",
            choices = sort(unique(start_data$Event_Year)),
            selected = latest_year)

selectInput('Event', 'Event',
            choices = start_data$Event)  # Set default to the first name in the sorted list

selectInput('Competition', 'Competition', choices = start_data$Competition)  # Set default to the first name in the sorted list

selectInput('is_complete_2', 'Skills', 
            choices = start_data$is_complete, 
            selected = "Complete")

pickerInput(
  inputId = "Stage",
  label = "Select Stage(s):", 
  choices = unique(start_data$Stage),
  selected = c("Final", "Qualification_2"),
  options = list(
    `actions-box` = TRUE,  # Adds "Select All" buttons
    `selected-text-format` = "count > 2"  # Shows count when >2 selected
  ),
  multiple = TRUE  # Allows multiple selections
)


# Observe changes in Club selection to update other inputs
# Observe changes in Club selection to update Competitor input
observeEvent(input$Event_Year, {
  if (input$Event_Year != "") {  # Only update if a club is selected
    filtered_data <- start_data |> filter(Event_Year == input$Event_Year)
    updateSelectInput(session, 'Event', choices = sort(unique(filtered_data$Event)))
  } else {
    updateSelectInput(session, 'Event', choices = NULL)
  }
})

# Observe changes in Competitor selection to update other inputs
observeEvent(input$Event, {
  if (input$Event != "") {  # Only update if a competitor is selected
    filtered_data <- start_data |>  filter(Event == input$Event)
    updateSelectInput(session, 'Competition', choices = sort(unique(filtered_data$Competition)))
    updateSelectInput(session, 'Stage', choices = sort(filtered_data$Stage), selected = c("Final", "Qualification_2"))
    updateSelectInput(session, 'is_complete_2', choices = sort(unique(filtered_data$is_complete)))
  } else {
    updateSelectInput(session, 'Competition', choices = NULL, selected = "Competition")
    updateSelectInput(session, 'Stage', choices = NULL, selected = c("Final", "Qualification_2"))
    updateSelectInput(session, 'is_complete_2', choices = NULL, selected = "Complete")
  }
})


```

## Column {data-width="200"}
```{r}

# Use a div with a specific height to create space
div(style = "height: 24px;")  # Adjust the height as needed

# Text output with dynamic content and inline styles
div(style = "font-size: 24px; font-weight: bold;", textOutput("eventLabel"))
# Server logic to update the text output
output$eventLabel <- renderText({
  selected_event <- input$Event
  if (selected_event != "") {
    paste(selected_event)
  } else {
    "No Event selected"
  }
})
```

### Execution

```{r}

renderPlot({
 update_raw_data() |> 
        filter(
           Event == input$Event,
           Competition == input$Competition,
           Stage %in% input$Stage,
           is_complete == input$is_complete_2  
           )  |>
ggplot(aes(x = as.numeric(factor(Competitor)), y = Execution)) +
    geom_jitter(width = 0.2, height = 0) +  # Adjust width and height for jitter effect
    theme_minimal() +
    labs(
         x = "Competitor",
         y = "Execution") +
    scale_x_continuous(breaks = NULL)+  # Remove x-axis labels
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

### Time of Flight(Seconds)

```{r}

renderPlot({
 update_raw_data() |> 
        filter(
           Event == input$Event,
           Competition == input$Competition,
           Stage %in% input$Stage,
           is_complete == input$is_complete_2  
           )  |>
ggplot(aes(x = as.numeric(factor(Competitor)), y = T)) +
    geom_jitter(width = 0.2, height = 0) +  # Adjust width and height for jitter effect
    theme_minimal() +
    labs(
         x = "Competitor",
         y = "ToF") +
    scale_x_continuous(breaks = NULL)+  # Remove x-axis labels
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

### Horizontal Displacement

```{r}

renderPlot({
 update_raw_data() |> 
        filter(
           Event == input$Event,
           Competition == input$Competition,
           Stage %in% input$Stage,
           is_complete == input$is_complete_2  
           )  |>
ggplot(aes(x = as.numeric(factor(Competitor)), y = H)) +
    geom_jitter(width = 0.2, height = 0) +  # Adjust width and height for jitter effect
    theme_minimal() +
    labs(
         x = "Competitor",
         y = "HD") +
    scale_x_continuous(breaks = NULL)+  # Remove x-axis labels
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

### Difficulty

```{r}

renderPlot({
 update_raw_data() |> 
        filter(
           Event == input$Event,
           Competition == input$Competition,
           Stage %in% input$Stage,
           is_complete == input$is_complete_2            
           )  |>
ggplot(aes(x = as.numeric(factor(Competitor)), y = D)) +
    geom_jitter(width = 0.2, height = 0) +  # Adjust width and height for jitter effect
    theme_minimal() +
    labs(
         x = "Competitor",
         y = "DD") +
    scale_x_continuous(breaks = NULL)+  # Remove x-axis labels
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

## Column {data-width="700"}

```{r}

# Use a div with a specific height to create space
div(style = "height: 24px;")  # Adjust the height as needed

# Text output with dynamic content and inline styles
div(style = "font-size: 24px; font-weight: bold;", textOutput("competitionLabel"))
# Server logic to update the text output
output$competitionLabel <- renderText({
  selected_competition <- paste("Competition:", input$Competition)
  if (selected_competition != "") {
    paste(selected_competition)
  } else {
    "No Competition selected"
  }
})
```

### Chart

```{r}
renderDT({
  # Filter the data using dplyr
  filtered_data <- score_data |> 

    filter(
           Event == input$Event,
           Competition == input$Competition,
           Stage %in% input$Stage,
           is_complete == input$is_complete_2 

)   |> 
    select(-c(Event_Year, Event, Competition, Date, is_complete, Total))

  # Render the data table with DT
datatable(
  filtered_data,
  rownames = FALSE,
    options = list(
    lengthMenu = list(c(25,50,100,-1),c(25,50,100,"All"))
  )
  
  
  )

})
```

# Data

## Column

### All Events

```{r}
renderDT(
  update_raw_data(), rownames = F, extensions = 'Buttons', filter="top", editable=T,
  options = list(
    dom = 'Blfrtip',
    buttons = c('csv', 'excel', 'pdf', 'print'),
    lengthMenu = list(c(10,50,100,-1),c(10,50,100,"All"))
  )
)
```
