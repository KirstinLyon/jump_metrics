---
title: "Kickout"
output:
  flexdashboard::flex_dashboard:
    navbar:
      - title: "Me"
        href: https://mltwelve.com/
        icon: "fa-home"
    theme: yeti
runtime: shiny
---


# Welcome to Kickout!

```{r setup, include=FALSE}
library(DT)
library(dplyr)
library(flexdashboard)
library(shiny)
library(readr)
library(lubridate)
library(ggplot2)
library(plotly)
library(shinyWidgets)
library(tidyr)


# Source the script that generates the 'events' dataset
events <- read_csv("Dataout/all_events.csv")


# events <-  read_csv("https://raw.githubusercontent.com/KirstinLyon/jump_metrics/refs/heads/main/Dataout/all_events.csv?token=GHSAT0AAAAAAC4QU5H3TALWBYUEP4K2ELQ22ALH6MQ")
# Use the 'events' dataset generated by fetch_data.R
start_data <- events  |> 
  mutate(Year = lubridate::year(Date)) |> 
  select(Year, Date, Event, Discipline, Competition, Competitor, Country, Club, Stage,
         Rank, Total, Mark, Elements, Execution, T, D, H, is_complete)  


compact_data <- start_data 

update_raw_data <- reactive({
  compact_data
})



```

## Column {data-width="400"}

**Kickout - Analysing Trampoline Competition Data**

This app provides insights into individual and synchronized trampoline events, focusing on trampoline gymnasts in Denmark, and specifically KÃ¸benhavns Trampoline Club (KTK). It uses data from SportTech.io and is updated each Monday. 

## Column {data-width="600"}



Trends
================

Column {.sidebar}
--------------------------------------------------------------

```{r}

# Sort competitor names alphabetically
sorted_club <- sort(unique(start_data$Club))

selectInput('Club', 'Club',
            choices = sorted_club,
            selected = "KTK")  # Set default to the first name in the sorted list

selectInput('Competitor', 'Competitor', choices = NULL)
selectInput('Discipline', 'Discipline', choices = NULL, selected = "TRA")
selectInput('is_complete', 'Skills', choices = start_data$is_complete, selected = "Complete")
pickerInput(
  inputId = "Stage",
  label = "Select Stage(s):", 
  choices = unique(start_data$Stage),
  selected = c("Final", "Qualification_2"),
  options = list(
    `actions-box` = TRUE,  # Adds "Select All" buttons
    `selected-text-format` = "count > 2"  # Shows count when >2 selected
  ),
  multiple = TRUE  # Allows multiple selections
)


# Observe changes in Club selection to update other inputs
# Observe changes in Club selection to update Competitor input
observeEvent(input$Club, {
  if (input$Club != "") {  # Only update if a club is selected
    filtered_data <- start_data |> filter(Club == input$Club)
    updateSelectInput(session, 'Competitor', choices = sort(unique(filtered_data$Competitor)))
  } else {
    updateSelectInput(session, 'Competitor', choices = NULL)
  }
})

# Observe changes in Competitor selection to update other inputs
observeEvent(input$Competitor, {
  if (input$Competitor != "") {  # Only update if a competitor is selected
    filtered_data <- start_data |>  filter(Competitor == input$Competitor)
    updateSelectInput(session, 'Discipline', choices = sort(unique(filtered_data$Discipline)), selected = "TRA")
    updateSelectInput(session, 'Stage', choices = sort(filtered_data$Stage), selected = c("Final", "Qualification_2"))
    updateSelectInput(session, 'is_complete', choices = sort(unique(filtered_data$is_complete)))
  } else {
    updateSelectInput(session, 'Discipline', choices = NULL, selected = "TRA")
    updateSelectInput(session, 'Stage', choices = NULL, selected = c("Final", "Qualification_2"))
    updateSelectInput(session, 'is_complete', choices = NULL, selected = "Complete")
  }
})

```


## Column {data-width="400"}



### Execution
```{r}
renderPlot({
 update_raw_data() |> 
    filter(Discipline == input$Discipline,
           Stage %in% input$Stage,
           Competitor == input$Competitor,
           is_complete == input$is_complete)  |>
    ggplot(aes(x = Date, y = Execution, colour = Stage)) +
    geom_line(linewidth = 0.95) +
    geom_point(size = 3) +  # This adds dots for each data point
    scale_color_hue(direction = 1) +
    labs( y = "Execution") +
    theme_minimal() +
    theme(legend.position = "top", legend.justification = "right")+
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

### Difficulty
```{r}
renderPlot({
 update_raw_data() |> 
    filter(Discipline == input$Discipline,
           Stage %in% input$Stage,
           Competitor == input$Competitor,
           is_complete == input$is_complete)  |>
    ggplot(aes(x = Date, y = D, colour = Stage)) +
    geom_line(linewidth = 0.95) +
    geom_point(size = 3) +  # This adds dots for each data point
    scale_color_hue(direction = 1) +
    labs( y = "Difficulty") +
    theme_minimal() +
    theme(legend.position = "top", legend.justification = "right")+
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```


### Time of Flight (Seconds)

```{r}
renderPlot({
 update_raw_data() |> 
    filter(Discipline == input$Discipline,
           Stage %in% input$Stage,
           Competitor == input$Competitor,
           is_complete == input$is_complete)  |>
    ggplot(aes(x = Date, y = T, colour = Stage)) +
    geom_line(linewidth = 0.95) +
    geom_point(size = 3) +  # This adds dots for each data point
    scale_color_hue(direction = 1) +
    labs(y = "Time of Flight (S)") +
    theme_minimal() +
    theme(legend.position = "top", legend.justification = "right")+
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```
### Horizontal Displacement

```{r}
renderPlot({
 update_raw_data() |> 
    filter(Discipline == input$Discipline,
           Stage %in% input$Stage,
           Competitor == input$Competitor,
           is_complete == input$is_complete)  |>
    ggplot(aes(x = Date, y = H, colour = Stage)) +
    geom_line(linewidth = 0.95) +
    geom_point(size = 3) +  # This adds dots for each data point
    scale_color_hue(direction = 1) +
    labs(y = "Horizontal Displacement") +
    theme_minimal() +
    theme(legend.position = "top", legend.justification = "right")+
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```


Column {data-width="600"}
----------------------------------------


### Overall Scores
```{r}

#renderPlot({
#  comp_data <- update_raw_data() |> 
#    filter(Discipline == input$Discipline,
#           Stage %in% input$Stage,
#           Competitor == input$Competitor,
#           is_complete == input$is_complete) |>
#    select(Date, Event, Discipline, Competition, Competitor, Stage,
#           Rank, Total, Mark, Elements, Execution, T, D, H) |> 
#    pivot_longer(cols = c(Execution, T, D, H),
#                 names_to = "Score_Type", 
#                 values_to = "Score")
  
#  ggplot(comp_data,  # You were using 'competition_data' instead of 'comp_data'
#         aes(x = interaction(Competition, Event, sep = " - "), 
#             y = Score, 
#             fill = fct_rev(Score_Type))) +
#    geom_bar(stat = "identity") +
 #   labs(title = "Total Scores by Competition and Event",
#         x = "Competition - Event",
#         y = "Score",
#         fill = "Score Type") +
#    scale_fill_manual(values = c("D" = "#E15759",       # Changed to match your column names
#                                "T" = "#59A14F",
#                                "H" = "#F28E2B",
#                                "Execution" = "#4E79A7")) +
#    theme_minimal() +
#    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
#          plot.title = element_text(hjust = 0.5, face = "bold"),
#          legend.position = "bottom") +
#    guides(fill = guide_legend(reverse = TRUE))
#})


```


Event Overview
================
column {.sidebar}
--------------------------------------------------------------

```{r}

# Set the default selected event in selectInput
selectInput('Event', 'Event', choices = start_data$Event)
selectInput('Competition', 'Competition', choices = NULL)


observeEvent(input$Event, {
  if (input$Event != "") {  # Only update if an event is selected
    filtered_data <- start_data |> filter(Event == input$Event)
    # Update Discipline input, ensuring "TRA" is the default if available
    # Update Competition input
    updateSelectInput(session, 'Competition', choices = sort(unique(filtered_data$Competition)))
  } else {
    # Reset inputs if no event is selected

    updateSelectInput(session, 'Competition', choices = NULL)
  }
})

```

## Column {data-width="400"}

### Execution
```{r}

renderPlot({
 update_raw_data() |> 
        filter(
           Event == input$Event,
           Competition == input$Competition)  |>
ggplot(aes(x = as.numeric(factor(Competitor)), y = Execution)) +
    geom_jitter(width = 0.2, height = 0) +  # Adjust width and height for jitter effect
    theme_minimal() +
    labs(
         x = "Competitor",
         y = "Execution") +
    scale_x_continuous(breaks = NULL)+  # Remove x-axis labels
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

### Time of Flight(Seconds)
```{r}

renderPlot({
 update_raw_data() |> 
        filter(
           Event == input$Event,
           Competition == input$Competition)  |>
ggplot(aes(x = as.numeric(factor(Competitor)), y = T)) +
    geom_jitter(width = 0.2, height = 0) +  # Adjust width and height for jitter effect
    theme_minimal() +
    labs(
         x = "Competitor",
         y = "ToF") +
    scale_x_continuous(breaks = NULL)+  # Remove x-axis labels
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

### Horizontal Displacement
```{r}

renderPlot({
 update_raw_data() |> 
        filter(
           Event == input$Event,
           Competition == input$Competition)  |>
ggplot(aes(x = as.numeric(factor(Competitor)), y = H)) +
    geom_jitter(width = 0.2, height = 0) +  # Adjust width and height for jitter effect
    theme_minimal() +
    labs(
         x = "Competitor",
         y = "HD") +
    scale_x_continuous(breaks = NULL)+  # Remove x-axis labels
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

### Difficulty
```{r}

renderPlot({
 update_raw_data() |> 
        filter(
           Event == input$Event,
           Competition == input$Competition)  |>
ggplot(aes(x = as.numeric(factor(Competitor)), y = D)) +
    geom_jitter(width = 0.2, height = 0) +  # Adjust width and height for jitter effect
    theme_minimal() +
    labs(
         x = "Competitor",
         y = "DD") +
    scale_x_continuous(breaks = NULL)+  # Remove x-axis labels
    expand_limits(y = 0)  # This one line forces y-axis to include 0
})
```

## Column {data-width="600"}

# Data

## Column

### All Events

```{r}
renderDT(
  update_raw_data(), rownames = F, extensions = 'Buttons', filter="top", editable=T,
  options = list(
    dom = 'Blfrtip',
    buttons = c('csv', 'excel', 'pdf', 'print'),
    lengthMenu = list(c(10,50,100,-1),c(10,50,100,"All"))
  )
)
```




